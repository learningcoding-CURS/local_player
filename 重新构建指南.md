# 重新构建指南

## 为什么需要重新构建？

从您的运行日志可以看出，当前运行的应用仍在使用旧的包名 `com.local.mediaplayer`。
我们已经将代码更新为新的包名 `com.localmedia.player`，但您需要重新构建项目才能应用这些更改。

## 🔄 完整的重新构建步骤

### 步骤 1：卸载旧版本应用

**在模拟器或真机上：**
1. 找到"本地播放器"应用图标
2. 长按应用图标
3. 选择"卸载"或"应用信息" → "卸载"

**或使用 ADB 命令：**
```bash
adb uninstall com.local.mediaplayer
```

### 步骤 2：清理项目

**在 Android Studio 中（推荐）：**
1. 点击菜单栏：**Build → Clean Project**
2. 等待清理完成（通常几秒钟）
3. 点击菜单栏：**File → Invalidate Caches**
4. 在弹出的对话框中，勾选所有选项
5. 点击 **Invalidate and Restart**
6. 等待 Android Studio 重启并重新索引项目

**使用命令行：**
```bash
# 进入项目根目录
cd "E:\local_lib\coding\播放器L2"

# 清理构建缓存
gradlew clean
gradlew cleanBuildCache
```

### 步骤 3：重新构建项目

**在 Android Studio 中（推荐）：**
1. 等待 Gradle 同步完成（右下角会显示进度）
2. 点击菜单栏：**Build → Rebuild Project**
3. 等待构建完成（首次可能需要 2-5 分钟）
4. 查看底部的"Build"标签页，确认没有错误

**使用命令行：**
```bash
gradlew assembleDebug
```

### 步骤 4：运行新版本

**在 Android Studio 中：**
1. 确保已连接设备或启动了模拟器
2. 点击顶部工具栏的绿色"运行"按钮（▶️）
3. 或使用快捷键：Shift + F10

**使用命令行安装：**
```bash
# 安装到连接的设备
adb install app/build/outputs/apk/debug/app-debug.apk
```

## ✅ 验证新版本

构建并安装后，检查以下内容确认使用的是新版本：

### 1. 检查包名
使用 logcat 查看日志，包名应该是 `com.localmedia.player`：
```bash
adb logcat | grep "com.localmedia.player"
```

如果仍然看到 `com.local.mediaplayer`，说明使用的是旧版本。

### 2. 检查应用信息
在设备上：
1. 打开"设置"
2. 进入"应用" → "本地播放器"
3. 查看"应用信息"中的包名

### 3. 运行时检查
新版本应该：
- ✅ 不再出现 `SecurityException` 错误（URI 权限已正确处理）
- ✅ 不再显示 `OnBackInvokedCallback is not enabled` 警告
- ✅ 返回键行为更流畅（Android 13+）

## 🐛 常见问题

### 问题 1：找不到 gradlew 命令
**原因**：项目根目录缺少 Gradle Wrapper 文件

**解决方案**：使用 Android Studio 打开项目，它会自动生成这些文件

### 问题 2：路径包含中文字符导致命令失败
**原因**：Windows CMD/PowerShell 对中文路径支持不佳

**解决方案**：
- 方案 A：使用 Android Studio 进行所有操作（推荐）
- 方案 B：使用 Git Bash 终端
- 方案 C：将项目移到纯英文路径

### 问题 3：构建失败，提示找不到某些类
**原因**：缓存问题或依赖未下载完成

**解决方案**：
1. **File → Invalidate Caches → Invalidate and Restart**
2. 等待 Gradle 同步完成（可能需要下载依赖）
3. **Build → Clean Project**
4. **Build → Rebuild Project**

### 问题 4：旧版本 APK 无法卸载
**原因**：应用可能设置为设备管理器或无障碍服务

**解决方案**：
1. 设置 → 安全 → 设备管理器 → 取消激活应用
2. 设置 → 无障碍 → 关闭应用的无障碍服务
3. 然后再卸载

## 📊 构建成功的标志

当您看到以下输出时，表示构建成功：

```
BUILD SUCCESSFUL in Xs
XX actionable tasks: XX executed, XX up-to-date
```

生成的 APK 文件位于：
```
app/build/outputs/apk/debug/app-debug.apk
```

## 🎯 预期改进

重新构建并安装后，您应该会注意到：

1. **包名正确**：日志中显示 `com.localmedia.player` 而不是 `com.local.mediaplayer`
2. **无权限错误**：文件选择后不再出现 SecurityException
3. **返回键流畅**：Android 13+ 设备上返回键有流畅的动画
4. **日志清晰**：不再有包名相关的警告

## 📞 需要帮助？

如果按照以上步骤仍然遇到问题：
1. 检查 Android Studio 的 Build 输出面板，查找具体错误信息
2. 检查 logcat 日志，查找运行时错误
3. 确认所有源代码文件都已保存
4. 尝试重启 Android Studio

---

**最后更新**: 2025-12-23  
**适用版本**: v1.0.13+

